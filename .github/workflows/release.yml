name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release-macos-dist:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Make scripts executable
        run: |
          chmod +x build.sh
          chmod +x scripts/build
          chmod +x scripts/*.sh

      - name: Verify build
        run: |
          go vet ./...
          go test ./...

      - name: Build release artifacts
        run: |
          short_sha="${GITHUB_SHA::7}"
          app_version="${GITHUB_REF_NAME#v}"
          VERSION="${app_version}" GIT_COMMIT="${short_sha}" ./build.sh

      - name: Upload dist artifact bundle
        uses: actions/upload-artifact@v4
        with:
          name: release-dist
          path: dist/**
          if-no-files-found: error

  release-windows-installer:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build Windows app package
        shell: bash
        run: |
          short_sha="${GITHUB_SHA::7}"
          app_version="${GITHUB_REF_NAME#v}"
          echo "APP_VERSION=${app_version}" >> "$GITHUB_ENV"
          echo "APP_COMMIT=${short_sha}" >> "$GITHUB_ENV"
          chmod +x scripts/build-windows-app.sh
          VERSION="${app_version}" GIT_COMMIT="${short_sha}" scripts/build-windows-app.sh

      - name: Install Inno Setup
        shell: powershell
        run: choco install innosetup --no-progress -y

      - name: Build Windows installer
        shell: powershell
        run: |
          $sourceDir = Join-Path $env:GITHUB_WORKSPACE "dist\\windows\\Kimmio Launcher"
          $outputDir = Join-Path $env:GITHUB_WORKSPACE "dist"
          iscc "/DAppVersion=$env:APP_VERSION" "/DAppExeName=KimmioLauncher.exe" "/DSourceDir=$sourceDir" "/DOutputDir=$outputDir" (Join-Path $env:GITHUB_WORKSPACE "scripts\\windows-installer.iss")

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-windows-setup
          path: dist/Kimmio-Launcher-Setup-windows-amd64.exe
          if-no-files-found: error

  publish:
    runs-on: ubuntu-latest
    needs: [release-macos-dist, release-windows-installer]

    steps:
      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: release-dist
          path: dist

      - name: Download windows installer artifact
        uses: actions/download-artifact@v4
        with:
          name: release-windows-setup
          path: dist

      - name: Merge installer into map.json
        run: |
          python3 - <<'PY'
          import json
          import os
          from datetime import datetime, timezone

          manifest_path = "dist/map.json"
          if os.path.exists(manifest_path):
              with open(manifest_path, "r", encoding="utf-8") as f:
                  data = json.load(f)
          else:
              data = {"generatedAt": "", "artifacts": []}

          installer_name = "Kimmio-Launcher-Setup-windows-amd64.exe"
          installer_path = f"dist/{installer_name}"
          if os.path.exists(installer_path):
              artifacts = data.setdefault("artifacts", [])
              if not any(a.get("path") == installer_name for a in artifacts):
                  artifacts.append({
                      "platform": "windows/amd64",
                      "type": "installer",
                      "name": installer_name,
                      "path": installer_name
                  })
              data["generatedAt"] = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")

          with open(manifest_path, "w", encoding="utf-8") as f:
              json.dump(data, f, indent=2)
              f.write("\n")
          PY

      - name: Rebuild checksums.txt
        run: |
          : > dist/checksums.txt
          find dist -type f ! -name "checksums.txt" | sort | while read -r file; do
            rel="${file#dist/}"
            sum="$(sha256sum "$file" | awk '{print $1}')"
            printf "%s  %s\n" "$sum" "$rel" >> dist/checksums.txt
          done

      - name: Create GitHub release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/**/*.zip
            dist/**/*.tar.gz
            dist/**/*.AppImage
            dist/**/*.exe
            dist/**/*.app/**
            dist/binaries/**
            dist/map.json
            dist/checksums.txt
