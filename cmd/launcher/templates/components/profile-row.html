{{ define "profile-row" }}
<div class="profile-card" data-profile-id="{{ .ID }}" data-active-job-id="{{ .ActiveJobID }}">


    <div class="card-content">
        <div class="card-header">
            <div class="identity-group">
                <div class="text-group">
                    <span class="profile-id">{{ .ID }}</span>
                    <span class="profile-version">
                        <i class="fa-solid fa-code-branch"></i>
                        <span class="version-label">Version</span>
                        <span class="version-chip">{{ .Version }}</span>
                    </span>
                </div>
            </div>
            <div class="status-pill {{ if eq .RuntimeStatus "running" }}online{{ else if eq .RuntimeStatus "starting" }}starting{{ else if eq .RuntimeStatus "unhealthy" }}unhealthy{{ else }}idle{{ end }}">
                <span class="pulse-dot"></span>
                <span>{{ if eq .RuntimeStatus "running" }}RUNNING{{ else if eq .RuntimeStatus "starting" }}STARTING{{ else if eq .RuntimeStatus "unhealthy" }}UNHEALTHY{{ else if .Enabled }}ENABLED{{ else }}STOPPED{{ end }}</span>
            </div>
        </div>

        <div class="card-body">
            <div class="resource-grid">
                <div class="res-item" title="Memory Allocation">
                    <i class="fa-solid fa-memory"></i>
                    <div class="res-meta">
                        <span class="res-label">RAM</span>
                        <span class="res-val">{{ if .Resources.Limits.Memory }}{{ .Resources.Limits.Memory }}{{ else }}Auto{{ end }}</span>
                    </div>
                </div>
                <div class="res-item" title="Processing Power">
                    <i class="fa-solid fa-microchip"></i>
                    <div class="res-meta">
                        <span class="res-label">CPU</span>
                        <span class="res-val">{{ if gt .Resources.Limits.CPUs 0.0 }}{{ printf "%.1f" .Resources.Limits.CPUs }}{{ else }}1.0{{ end }} cores</span>
                    </div>
                </div>
                <div class="res-item" title="Network Access">
                    <i class="fa-solid fa-ethernet"></i>
                    <div class="res-meta">
                        <span class="res-label">PORT</span>
                        <span class="res-val">{{ range .Ports }}{{ .Host }}{{ end }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-footer">
            <div class="action-primary">
                {{ if .Running }}
                <button class="launch-action-kimmio" onclick="openProfile('{{ .ID }}', {{ range .Ports }}{{ .Host }}{{ end }})">
                    <i class="fa-solid fa-up-right-from-square"></i>
                    <span>Open</span>
                </button>
                {{ else }}
                <button class="util-btn action-enable js-profile-action" onclick="enableProfile('{{ .ID }}', this)">
                    <i class="fa-solid fa-play"></i>
                    <span>Enable now</span>
                </button>
                {{ end }}
                {{ if .Enabled }}
                <button class="util-btn action-stop js-profile-action" onclick="stopProfile('{{ .ID }}', this)">
                    <i class="fa-solid fa-stop"></i>
                    <span>Stop</span>
                </button>
                {{ end }}
                <details class="action-menu">
                    <summary class="util-btn action-more">
                        <i class="fa-solid fa-ellipsis"></i>
                        <span>More actions</span>
                    </summary>
                    <div class="action-menu-panel">
                        <button class="util-btn action-update js-profile-action" onclick="updateProfileVersion('{{ .ID }}', '{{ .Version }}', this)">
                            <i class="fa-solid fa-arrow-up"></i>
                            <span>Update version</span>
                        </button>
                        <button class="util-btn action-secrets js-profile-action" onclick="regenerateSecrets('{{ .ID }}', this)" title="Generate new JWT and encryption keys">
                            <i class="fa-solid fa-key"></i>
                            <span>Regenerate secrets</span>
                        </button>
                        <button class="util-btn action-recreate js-profile-action" onclick="recreateProfile('{{ .ID }}', this)" title="Destructive: resets volumes/data">
                            <i class="fa-solid fa-rotate-right"></i>
                            <span>Recreate</span>
                        </button>
                        <button class="util-btn delete js-profile-action" onclick="deleteProfile('{{ .ID }}', this)">
                            <i class="fa-solid fa-trash"></i>
                            <span>Delete</span>
                        </button>
                    </div>
                </details>
            </div>
        </div>


        <div class="row-feedback" data-feedback="{{ .ID }}">
            <div class="job-progress is-hidden" data-progress="{{ .ID }}">
                <div class="job-progress-bar" data-progress-bar="{{ .ID }}" style="width: 0%"></div>
            </div>
            <div class="job-live-logs is-hidden" data-live-logs="{{ .ID }}"></div>
            <button type="button" class="cancel-task-btn is-hidden" data-cancel-btn="{{ .ID }}" onclick="cancelProfileJob('{{ .ID }}', this)">
                <i class="fa-solid fa-ban"></i>
                <span>Cancel task</span>
            </button>
            {{ if .Enabled }}
            <a class="profile-local-url" href="http://localhost:{{ range .Ports }}{{ .Host }}{{ end }}" target="_blank" rel="noopener noreferrer">
                <i class="fa-solid fa-link"></i>
                <span>http://localhost:{{ range .Ports }}{{ .Host }}{{ end }}</span>
            </a>
            {{ end }}
            {{ if .LastActionResult }}
            <div class="feedback-line">{{ .LastActionResult }}</div>
            {{ end }}
            {{ if .ActionLog }}
            <div class="feedback-log">{{ index .ActionLog 0 }}</div>
            {{ end }}
            {{ if and (eq .LastAction "enable") (eq .LastActionStatus "failed") }}
            <button class="retry-link" onclick="retryEnable('{{ .ID }}', this)">
                <i class="fa-solid fa-rotate-right"></i> Retry Enable
            </button>
            {{ end }}
            {{ if and (eq .LastAction "version") (eq .LastActionStatus "failed") }}
            <button class="retry-link" onclick="retryVersion('{{ .ID }}', '{{ .LastRequestedVersion }}', this)">
                <i class="fa-solid fa-rotate-right"></i> Retry Version Update
            </button>
            {{ end }}
        </div>
    </div>
</div>

<style>

    :root {
        --primary-glow: #2dd798;
        --bg-dark: #0a0a0c;
        --card-bg: rgba(20, 20, 24, 0.8);
        --border-color: rgba(255, 255, 255, 0.08);
        --text-muted: #80808b;

    }

    /* Card Container */
    .profile-card {
        position: relative;
        background: linear-gradient(180deg, rgba(239, 239, 239, 0.03), rgba(52, 52, 52, 0.01));
        border: 1px solid rgba(255, 255, 255, 0.09);
        z-index: 2222;
        isolation: isolate;
        border-radius: 18px;
        padding: 22px;
        margin-bottom: 16px;
        transition: border-color 0.2s ease, box-shadow 0.25s ease, transform 0.2s ease;
        box-shadow:
            inset 0 1px 0 rgba(255, 255, 255, 0.05),
            inset 0 -1px 0 rgba(255, 255, 255, 0.015),
            0 12px 20px rgba(0, 0, 0, 0.22),
            0 24px 44px rgba(0, 0, 0, 0.34);
        backdrop-filter: blur(10px);
    }

    .profile-card:hover {
        border-color: rgba(225, 225, 225, 0.16);
        box-shadow:
            inset 0 1px 0 rgba(255, 255, 255, 0.07),
            inset 0 -1px 0 rgba(255, 255, 255, 0.02),
            0 16px 26px rgba(0, 0, 0, 0.28),
            0 28px 50px rgba(0, 0, 0, 0.4);
        transform: translateY(-1px);
    }


    .profile-card:hover .card-glow {
        opacity: 0.09;
    }

    .card-content {
        position: relative;
        z-index: 1;
        overflow: visible;
    }

    /* Header Section */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
        flex-wrap: wrap;
    }

    .identity-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .profile-id {
        display: block;
        font-size: 28px;
        font-weight: 800;
        color: #fff;
        letter-spacing: -0.4px;
        line-height: 1.05;
        margin-bottom: 1rem;
    }

    .profile-version {
        margin-top: 2px;
        font-size: 12px;
        color: #aeb5c2;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
    }

    .profile-version i {
        color: #7f8898;
    }

    .version-label {
        letter-spacing: 0.4px;
        text-transform: uppercase;
        font-size: 10px;
        color: #8f97a6;
    }

    .version-chip {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(109, 183, 255, 0.16);
        border: 1px solid rgba(109, 183, 255, 0.38);
        color: #d9ebff;
        font-size: 11px;
        font-weight: 800;
        letter-spacing: 0.3px;
    }

    /* Status Pills */
    .status-pill {
        display: flex;
        align-items: center;
        gap: 7px;
        padding: 7px 11px;
        border-radius: 100px;
        font-size: 10px;
        font-weight: 800;
        letter-spacing: 0.8px;
        border: 1px solid transparent;
        box-shadow: -20px 10px 1rem 0.3rem rgba(0, 0, 0, 0.25) inset;

        white-space: nowrap;
    }

    .status-pill.online {
        background: rgba(45, 215, 152, 0.14);
        color: #3ce4a5;
        border-color: rgba(45, 215, 152, 0.35);
        border-top-color: rgba(8, 243, 155, 0.36);
    }

    .status-pill.idle {
        background: rgba(255, 255, 255, 0.05);
        color: #9da2ab;
        border-color: rgba(255, 255, 255, 0.12);
    }

    .status-pill.starting {
        background: rgba(245, 185, 74, 0.13);
        color: #f5b94a;
        border-color: rgba(245, 185, 74, 0.38);
    }

    .status-pill.unhealthy {
        background: rgba(255, 68, 102, 0.12);
        color: #ff4466;
        border-color: rgba(255, 68, 102, 0.35);
    }

    .pulse-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: currentColor;
    }

    .online .pulse-dot {
        animation: pulse-green 2s infinite;
    }

    @keyframes pulse-green {
        0% {
            box-shadow: 0 0 0 0 rgba(0, 255, 170, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(0, 255, 170, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(0, 255, 170, 0);
        }
    }

    /* Body Section */
    .resource-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
        padding: 12px;
        background: rgba(14, 14, 14, 0.34);
        border-radius: 12px;
        margin-bottom: 14px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow:
            inset 0 1px 0 rgba(255, 255, 255, 0.03),
            0 8px 18px rgba(0, 0, 0, 0.22);
    }

    .res-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 9px 10px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.03);
        box-shadow:
            inset 0 1px 0 rgba(255, 255, 255, 0.02),
            0 6px 12px rgba(0, 0, 0, 0.14);
        min-width: 0;
    }

    .res-item i {
        font-size: 14px;
        color: #5f6673;
        flex-shrink: 0;
    }

    .res-meta {
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .res-label {
        font-size: 10px;
        font-weight: 800;
        color: #737a86;
        text-transform: uppercase;
        letter-spacing: 0.6px;
    }

    .res-val {
        font-size: 14px;
        color: #e3e6ee;
        font-weight: 700;
        white-space: nowrap;
        overflow: hidden;
        scrollbar-color: darkgray transparent;
        text-overflow: ellipsis;
    }

    /* Footer Section */
    .card-footer {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .action-primary {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .action-menu {
        position: relative;
    }

    .action-menu summary {
        list-style: none;
    }

    .action-menu summary::-webkit-details-marker {
        display: none;
    }

    .action-more {
        border-color: rgba(255, 255, 255, 0.22);
    }

    .action-more:hover {
        border-color: rgba(255, 255, 255, 0.4);
        color: #fff;
    }

    .action-menu-panel {
        position: fixed;
        right: 28px;
        bottom: 28px;
        width: min(320px, calc(100vw - 24px));
        display: none;
        flex-direction: column;
        gap: 6px;
        padding: 10px;
        border-radius: 12px;
        background: rgba(10, 10, 14, 0.98);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow:
            inset 0 1px 0 rgba(255, 255, 255, 0.04),
            0 14px 26px rgba(0, 0, 0, 0.42),
            0 28px 52px rgba(0, 0, 0, 0.34);
        z-index: 999;
    }

    .action-menu[open] .action-menu-panel {
        display: flex;
    }

    .action-menu-panel .util-btn {
        width: 100%;
        justify-content: flex-start;
    }

    .profile-card.is-busy .action-menu summary {
        pointer-events: none;
        opacity: 0.6;
    }

    .util-btn,
    .launch-action-kimmio {
        height: 38px;
        padding: 0 14px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.25px;
        text-transform: none;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.03);
        color: #d2d4db;
        cursor: pointer;
        transition: 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow:
            inset 0 1px 0 rgba(255, 255, 255, 0.03),
            0 4px 10px rgba(0, 0, 0, 0.14);
    }

    .util-btn i,
    .launch-action-kimmio i {
        font-size: 11px;
    }

    .launch-action-kimmio {
        border-color: rgba(0, 255, 170, 0.35);
        color: #e9fffa;
        background: linear-gradient(180deg, rgba(0, 255, 170, 0.15), rgba(0, 255, 170, 0.06));
    }

    .launch-action-kimmio:hover {
        border-color: rgba(0, 255, 170, 0.65);
        color: #2dd798;
        transform: translateY(-1px);
    }

    .action-enable {
        border-color: rgba(13, 252, 164, 0.7);
        border-top-color: rgba(149, 241, 205, 0.82);
        background:
            linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0) 38%),
            linear-gradient(180deg, rgba(83, 229, 175, 0.37), rgba(67, 115, 98, 0.37));
        color: #eafff5;
        box-shadow:
            inset 0 1px 0 rgba(255, 255, 255, 0.16),
            inset 0 -1px 0 rgba(0, 0, 0, 0.18),
            0 0 0 1px rgba(45, 215, 152, 0.26),
            0 8px 18px rgba(10, 40, 28, 0.35),
            0 16px 30px -16px rgba(45, 215, 152, 0.38);
    }

    .action-enable:hover {
        color: #ffffff;
        border-color: rgba(45, 215, 152, 0.95);
        background:
            linear-gradient(180deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.01) 40%),
            linear-gradient(180deg, rgba(45, 215, 152, 0.4), rgba(45, 215, 152, 0.18));
        transform: translateY(-1px);
        box-shadow:
            inset 0 1px 0 rgba(255, 255, 255, 0.2),
            inset 0 -1px 0 rgba(0, 0, 0, 0.2),
            0 0 0 1px rgba(45, 215, 152, 0.38),
            0 10px 20px rgba(10, 40, 28, 0.4),
            0 18px 34px -16px rgba(45, 215, 152, 0.95);
    }

    .action-enable:active {
        transform: translateY(0);
        box-shadow:
            inset 0 1px 0 rgba(255, 255, 255, 0.1),
            inset 0 2px 6px rgba(0, 0, 0, 0.25),
            0 0 0 1px rgba(45, 215, 152, 0.3),
            0 6px 14px rgba(10, 40, 28, 0.28);
    }



    .action-stop:hover {
        color: #f5b94a;
        border-color: rgba(245, 185, 74, 0.65);
        background: rgba(245, 185, 74, 0.08);
    }

    .action-recreate:hover {
        color: #c38dff;
        border-color: rgba(195, 141, 255, 0.65);
        background: rgba(195, 141, 255, 0.08);
    }

    .action-update:hover {
        color: #6db7ff;
        border-color: rgba(109, 183, 255, 0.65);
        background: rgba(109, 183, 255, 0.08);
    }

    .action-secrets:hover {
        color: #ffd36d;
        border-color: rgba(255, 211, 109, 0.65);
        background: rgba(255, 211, 109, 0.08);
    }

    .util-btn.delete:hover {
        color: #ff4466;
        border-color: rgba(255, 68, 102, 0.55);
        background: rgba(255, 68, 102, 0.08);
    }

    .row-feedback {
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        background: rgba(54, 54, 54, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow:
            inset 0 1px 0 rgba(255, 255, 255, 0.03),
            0 10px 18px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    .job-progress {
        width: 100%;
        height: 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        overflow: hidden;
        margin-bottom: 6px;
    }

    .job-progress.is-hidden {
        display: none;
    }

    .job-progress-bar {
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, #2dd798, #6be8bc);
        transition: width 0.35s ease;
    }

    .job-live-logs {
        margin-bottom: 6px;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(7, 8, 12, 0.9);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);
        max-height: 130px;
        overflow: auto;
        font-size: 11px;
        line-height: 1.35;
        color: #aeb5c2;
        font-family: var(--mono);
        white-space: pre-wrap;
    }

    .job-live-logs.is-hidden {
        display: none;
    }

    .cancel-task-btn {
        height: 30px;
        display: inline-flex;
        align-items: center;
        gap: 7px;
        padding: 0 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 140, 107, 0.55);
        background: rgba(255, 140, 107, 0.12);
        color: #ffd8cd;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.25px;
        cursor: pointer;
    }

    .cancel-task-btn:hover {
        border-color: rgba(255, 140, 107, 0.85);
        background: rgba(255, 140, 107, 0.2);
        color: #fff0ec;
    }

    .cancel-task-btn.is-hidden {
        display: none;
    }

    .profile-local-url {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #8fd2ff;
        font-size: 12px;
        font-weight: 700;
        text-decoration: none;
        width: fit-content;
        max-width: 100%;
    }

    .profile-local-url span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .profile-local-url:hover {
        color: #b9e6ff;
        text-decoration: underline;
    }

    .feedback-line {
        font-size: 12px;
        color: #d8dbe2;
    }

    .feedback-log {
        font-size: 11px;
        color: #8d8d94;
        font-family: var(--mono);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .retry-link {
        margin-top: 2px;
        align-self: flex-start;
        background: transparent;
        border: none;
        color: #7cc8ff;
        font-size: 12px;
        padding: 0;
        cursor: pointer;
    }

    .retry-link:hover {
        color: #9ed7ff;
    }

    @media (max-width: 900px) {
        .resource-grid {
            grid-template-columns: 1fr;
        }
    }

</style>
{{ end }}
